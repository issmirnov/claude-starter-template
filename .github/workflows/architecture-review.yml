name: Architecture Review

on:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review]
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  architect-gate:
    name: "Architect-Gate Review"
    # Run on PR events (except closed), or when someone comments @architect-run
    if: |
      (github.event_name == 'pull_request' && github.event.action != 'closed') ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@architect-run'))
    runs-on: ubuntu-latest
    timeout-minutes: 15  # Prevent hanging workflows, Claude reviews typically <5 min

    steps:
      - name: Get PR details for comment-triggered runs
        if: github.event_name == 'issue_comment'
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            if (!issue.pull_request) {
              core.setFailed('Comment is not on a pull request');
              return;
            }

            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: issue.number
            });

            core.setOutput('head_ref', pr.data.head.ref);
            core.setOutput('head_sha', pr.data.head.sha);
            core.setOutput('base_ref', pr.data.base.ref);
            core.setOutput('pr_number', issue.number);
            core.setOutput('repository', pr.data.head.repo.full_name);

      - name: Checkout PR head
        uses: actions/checkout@v4
        with:
          # For comment-triggered runs, use PR head ref
          repository: ${{ github.event_name == 'issue_comment' && steps.pr.outputs.repository || github.repository }}
          ref: ${{ github.event_name == 'issue_comment' && steps.pr.outputs.head_ref || github.head_ref }}
          # Fetch full history so model can see all commits in PR
          fetch-depth: 0

      - name: Fetch base branch
        run: |
          # Determine base ref (from PR event or comment-triggered PR lookup)
          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            BASE_REF="${{ steps.pr.outputs.base_ref }}"
          else
            BASE_REF="${{ github.base_ref || 'main' }}"
          fi

          # Fetch full history of base branch (no --depth limit)
          git fetch origin ${BASE_REF}

      - name: Generate diff context
        id: diff
        run: |
          # Create temp directory for context files
          mkdir -p /tmp/architect-gate

          # Determine base ref
          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            BASE_REF="${{ steps.pr.outputs.base_ref }}"
          else
            BASE_REF="${{ github.base_ref || 'main' }}"
          fi

          # Generate unified diff vs base branch (use triple-dot for merge base)
          git diff --unified=3 origin/${BASE_REF}...HEAD > /tmp/architect-gate/pr.diff

          echo "diff_path=/tmp/architect-gate/pr.diff" >> $GITHUB_OUTPUT
          echo "base_ref=${BASE_REF}" >> $GITHUB_OUTPUT

          # Count changed files for metrics
          CHANGED_FILES=$(git diff --name-only origin/${BASE_REF}...HEAD | wc -l)
          echo "changed_files=${CHANGED_FILES}" >> $GITHUB_OUTPUT

          # Get commit count in PR for context
          COMMIT_COUNT=$(git rev-list --count origin/${BASE_REF}..HEAD)
          echo "commit_count=${COMMIT_COUNT}" >> $GITHUB_OUTPUT

          # Show diff stats for debugging
          echo "ğŸ“Š PR Stats:"
          echo "   Base: origin/${BASE_REF}"
          echo "   Head: HEAD ($(git rev-parse --short HEAD))"
          echo "   Files changed: ${CHANGED_FILES}"
          echo "   Commits: ${COMMIT_COUNT}"

      - name: Compose prompts
        id: prompts
        run: |
          # Concatenate numbered prompts in order
          # Start with general architecture review (required)
          cat .github/claude/prompts/01-general-architecture-review.prompt.md \
              > /tmp/architect-gate/full-prompt.md

          # Add project-specific prompts if they exist (02-*.prompt.md files)
          # You can have multiple: 02-project-rules.prompt.md, 03-security-hardening.prompt.md, etc.
          for prompt in .github/claude/prompts/02-*.prompt.md .github/claude/prompts/03-*.prompt.md; do
            if [ -f "$prompt" ]; then
              echo "" >> /tmp/architect-gate/full-prompt.md
              echo "---" >> /tmp/architect-gate/full-prompt.md
              echo "" >> /tmp/architect-gate/full-prompt.md
              cat "$prompt" >> /tmp/architect-gate/full-prompt.md
              echo "ğŸ“ Added: $prompt"
            fi
          done

          echo "prompt_path=/tmp/architect-gate/full-prompt.md" >> $GITHUB_OUTPUT

          # Show prompt size for metrics
          PROMPT_SIZE=$(wc -l < /tmp/architect-gate/full-prompt.md)
          echo "Composed prompt: ${PROMPT_SIZE} lines"

      - name: Run Claude Architect-Gate
        id: claude
        uses: anthropics/claude-code-base-action@980cb83cd01e2a1478e9eb6d5e89ec6665f3fd60  # Pin to specific SHA for stability
        with:
          prompt_file: ${{ steps.prompts.outputs.prompt_path }}
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          settings: |
            {
              "model": "claude-3-5-haiku-20241022"
            }
          show_full_output: true
        continue-on-error: true  # Allow retry on failure

      - name: Retry Claude Architect-Gate (if first attempt failed)
        id: claude_retry
        if: steps.claude.outcome == 'failure'
        uses: anthropics/claude-code-base-action@980cb83cd01e2a1478e9eb6d5e89ec6665f3fd60
        with:
          prompt_file: ${{ steps.prompts.outputs.prompt_path }}
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          settings: |
            {
              "model": "claude-3-5-haiku-20241022"
            }
          show_full_output: true

      - name: Save System Architecture Review (SAR)
        run: |
          mkdir -p artifacts

          # Determine which Claude step succeeded (initial or retry)
          if [ "${{ steps.claude.outcome }}" = "success" ]; then
            EXEC_FILE="${{ steps.claude.outputs.execution_file }}"
            CONCLUSION="${{ steps.claude.outputs.conclusion }}"
            ATTEMPT="initial"
          else
            EXEC_FILE="${{ steps.claude_retry.outputs.execution_file }}"
            CONCLUSION="${{ steps.claude_retry.outputs.conclusion }}"
            ATTEMPT="retry"
          fi

          echo "ğŸ“ Using Claude execution from: ${ATTEMPT} attempt"

          if [ -f "$EXEC_FILE" ]; then
            # Extract the last assistant message (SAR) from the execution JSON
            # The execution file contains the full conversation history
            cat "$EXEC_FILE" | jq -r '
              [.[] | select(.type == "assistant" and .message.role == "assistant")]
              | last
              | .message.content
              | if type == "array" then
                  map(select(.type == "text") | .text) | join("\n\n")
                else
                  .
                end
            ' > artifacts/SAR-${{ github.sha }}.md

            # Copy full execution log for debugging
            cp "$EXEC_FILE" artifacts/execution-log.json
          else
            echo "âš ï¸ No execution file found at: $EXEC_FILE"
            echo "Claude execution may have failed or not produced output"
            echo "" > artifacts/SAR-${{ github.sha }}.md
          fi

          # Determine PR number and base ref based on event type
          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            PR_NUM="${{ steps.pr.outputs.pr_number }}"
            BASE="${{ steps.pr.outputs.base_ref }}"
          else
            PR_NUM="${{ github.event.pull_request.number }}"
            BASE="${{ github.base_ref || 'main' }}"
          fi

          # Add metadata
          cat > artifacts/metadata.json <<EOF
          {
            "pr_number": "${PR_NUM}",
            "sha": "${{ github.sha }}",
            "base_ref": "${BASE}",
            "changed_files": ${{ steps.diff.outputs.changed_files }},
            "commit_count": ${{ steps.diff.outputs.commit_count }},
            "event_type": "${{ github.event_name }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "claude_conclusion": "${CONCLUSION}",
            "claude_attempt": "${ATTEMPT}"
          }
          EOF

      - name: Parse severity and blockers
        id: gate
        run: |
          SAR_FILE="artifacts/SAR-${{ github.sha }}.md"

          # Extract severity (0-4) from footer - search from END to get actual footer, not examples
          SEVERITY=$(grep -Eo 'SEVERITY: [0-4]' ${SAR_FILE} | tail -1 | awk '{print $2}' | tr -d '\n' || echo "0")
          echo "severity=${SEVERITY}" >> $GITHUB_OUTPUT

          # Extract blockers flag - search from END
          BLOCKERS=$(grep -Eo 'BLOCKERS: (true|false)' ${SAR_FILE} | tail -1 | awk '{print $2}' | tr -d '\n' || echo "false")
          echo "blockers=${BLOCKERS}" >> $GITHUB_OUTPUT

          # Extract risk areas - search from END
          RISK_AREAS=$(grep -Eo 'RISK_AREAS: (.*)' ${SAR_FILE} | tail -1 | cut -d: -f2- | tr -d '\n' || echo "none")
          echo "risk_areas=${RISK_AREAS}" >> $GITHUB_OUTPUT

          echo "ğŸ“Š Gate Check Results:"
          echo "   Severity: ${SEVERITY}/4"
          echo "   Blockers: ${BLOCKERS}"
          echo "   Risk Areas: ${RISK_AREAS}"

      - name: Comment SAR on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const sarPath = 'artifacts/SAR-${{ github.sha }}.md';
            const sar = fs.readFileSync(sarPath, 'utf8');

            // Add header with gate status
            const severity = parseInt('${{ steps.gate.outputs.severity }}') || 0;
            const blockers = '${{ steps.gate.outputs.blockers }}' === 'true';

            let statusEmoji = 'âœ…';
            let statusText = 'No issues found';

            if (blockers || severity >= 3) {
              statusEmoji = 'ğŸš«';
              statusText = 'Changes required before merge';
            } else if (severity === 2) {
              statusEmoji = 'âš ï¸';
              statusText = 'Advisory recommendations';
            }

            // Format timestamp
            const timestamp = new Date().toISOString().replace('T', ' ').substring(0, 19) + ' UTC';

            const header = `## ${statusEmoji} Architecture Review - ${statusText}

            **Severity**: ${severity}/4 | **Blockers**: ${blockers} | **Files**: ${{ steps.diff.outputs.changed_files }} | **Commits**: ${{ steps.diff.outputs.commit_count }}

            <details>
            <summary>ğŸ“‹ Full System Architecture Review (SAR)</summary>

            ${sar}

            </details>

            ---
            *Generated by Architect-Gate on ${timestamp}*
            `;

            // Get PR number (works for both PR events and comment triggers)
            let issue_number;
            if (context.eventName === 'issue_comment') {
              issue_number = context.payload.issue.number;
            } else {
              issue_number = context.payload.pull_request.number;
            }

            // Post comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
              body: header
            });

      - name: Upload SAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: SAR-${{ github.sha }}
          path: artifacts/
          retention-days: 90

      - name: Enforce gate decision
        if: always()
        run: |
          SEVERITY=${{ steps.gate.outputs.severity }}
          BLOCKERS=${{ steps.gate.outputs.blockers }}

          echo "ğŸš¦ Gate Decision:"
          echo "   Severity: ${SEVERITY}/4"
          echo "   Blockers: ${BLOCKERS}"

          # Fail if severity >= 3 OR blockers present
          if [ "${BLOCKERS}" = "true" ] || [ "${SEVERITY}" -ge 3 ]; then
            echo "âŒ Gate FAILED: Architectural issues must be resolved"
            echo ""
            echo "ğŸ“– Review the System Architecture Review (SAR) comment above"
            echo "ğŸ”§ Address blocker issues and push new commits"
            echo "ğŸ”„ The review will re-run automatically"
            exit 1
          fi

          echo "âœ… Gate PASSED: Architecture review looks good"
